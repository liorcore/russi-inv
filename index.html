<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>专转 砖 - 拽祝 转" 注转拽</title>
    <meta name="description" content="注专转 砖专 注  砖">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* 专转 转 */
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            margin: 0;
            background-color: #e0d8c0; /* 专拽注  专 转专 */
        }

        .scroll {
            /* 专 拽祝 驻专  驻驻专住  */
            background-color: #fcefd9; /* 爪注 砖转/住驻 专 */
            border: 4px solid #a0522d; /*   注拽 */
            /* 爪 驻 注   */
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.4), inset 0 0 30px rgba(230, 200, 150, 0.5); 
            padding: 50px 70px; 
            max-width: 650px;
            width: 90%;
            text-align: center; /* 砖专 拽住 专 拽砖转 */
            font-family: 'Times New Roman', 'Noto Serif Hebrew', serif; /* 驻 住专祝 注转拽 */
            color: #331a00; /* 爪注     */
            line-height: 1.8; /* 专  转专  砖专转 */
            direction: rtl;
        }

        .title {
            font-size: 2.8em;
            font-weight: 700;
            margin-bottom: 30px;
            color: #6a0000; /*   注拽 转专转 */
            border-bottom: 2px solid #6a0000;
            display: block;
            padding-bottom: 8px;
            text-align: center; 
        }

        .verse {
            font-size: 1.4em; 
            margin-bottom: 15px;
            text-indent: 0; 
            padding-right: 0; 
        }

        .emphasis {
            font-weight: 700;
            color: #6a0000; /*   注拽 砖转  注拽专转 */
        }
        
        /* 住  驻住拽 砖 -  专  转 住驻专 */
        .highlighted-verse {
            font-size: 1.8em; 
            font-weight: 700;
            margin: 40px 0;
            padding: 15px;
            background-color: rgba(160, 82, 45, 0.1); /* 专拽注 砖拽祝 注 */
            border-top: 3px double #a0522d; /* 住专转 拽专转  注拽 */
            border-bottom: 3px double #a0522d;
            border-radius: 0;
            line-height: 1.5;
            color: #4f2c00; /*    */
            text-align: center;
            text-indent: 0;
        }
        /* 砖 转 驻住拽 注爪 */
        .highlighted-verse .emphasis {
             font-size: 1.2em; 
             color: #6a0000; /* 砖 转 拽注  */
             font-style: italic;
        }
        
        /* 住 砖专转 住 - 转专 住专转 */
        .deluxe {
            font-size: 1.5em;
            font-style: normal;
            font-weight: 700;
            color: #6a0000; /*  注转拽 */
            margin-top: 40px;
            border-top: 1px solid #a0522d;
            padding-top: 15px;
            text-align: center;
        }
        
        /* --- 住 驻转专 转" --- */
        .tannach-btn {
            font-family: 'Times New Roman', serif;
            font-weight: 700;
            padding: 12px 24px;
            font-size: 1.25rem; /* text-xl */
            border-radius: 4px;
            transition: all 0.2s;
            box-shadow: 2px 2px 5px rgba(0, 0, 0, 0.2);
            text-align: center;
        }

        /* 驻转专 注 - /拽祝 专注 */
        .tannach-btn-gold {
            background-color: #e8d8b8; /* 爪注  注转拽 / 拽祝  */
            color: #331a00; /*    */
            border: 2px solid #a0522d; /*   注拽 */
        }
        .tannach-btn-gold:hover {
            background-color: #d1c3a6; /* 注  转专 专 */
            transform: translateY(-1px);
            box-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
        }

        /* 驻转专  注 - 驻专专/注爪 */
        .tannach-btn-ash {
            background-color: #884a4a; /* -驻专专 */
            color: #fcefd9; /* 爪注 拽祝 专 ( ) */
            border: 2px solid #6a0000; /*    注拽 */
        }
        .tannach-btn-ash:hover {
            background-color: #753a3a; /*  转专 专 */
            transform: translateY(-1px);
            box-shadow: 3px 3px 6px rgba(0, 0, 0, 0.3);
        }
        
        /* 住  () */
        .modal {
            display: none; /* 住转专 专专转  */
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto; /* 住专  */
            padding: 25px;
            border: 1px solid #888;
            width: 90%;
            max-width: 480px; /*  驻专驻专爪 转专 */
            border-radius: 12px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            text-align: right;
            direction: rtl;
        }

        /* --- 驻拽 拽驻 (FULL SCREEN) --- */
        /* Keyframes  驻爪抓 (blast) 注 驻专  (fall)  住 */
        @keyframes confetti-fall {
            0% { opacity: 0; transform: translate(0, 0) rotate(0deg); }
            10% { opacity: 1; transform: translate(var(--start-x), var(--blast-y)) rotate(var(--rot-start)); }
            100% { opacity: 0; transform: translate(var(--end-x), var(--fall-y)) rotate(var(--rot-end)); }
        }
        
        .confetti-particle {
            position: absolute;
            width: 10px;
            height: 10px;
            opacity: 0;
            /* 砖砖 砖转 CSS  */
            animation-name: confetti-fall;
            animation-timing-function: cubic-bezier(0.1, 1, 0.4, 1);
            animation-fill-mode: forwards;
            pointer-events: none;
            border-radius: 2px;
        }
        
        /* --- 驻拽 注爪 (SHAKE) --- */
        @keyframes shake {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            10% { transform: translate(-51%, -52%) rotate(-1deg); }
            20% { transform: translate(-53%, -50%) rotate(1deg); }
            30% { transform: translate(-47%, -48%) rotate(0deg); }
            40% { transform: translate(-49%, -51%) rotate(1deg); }
            50% { transform: translate(-51%, -48%) rotate(-1deg); }
            60% { transform: translate(-53%, -49%) rotate(0deg); }
            70% { transform: translate(-47%, -49%) rotate(-1deg); }
            80% { transform: translate(-51%, -51%) rotate(1deg); }
            90% { transform: translate(-49%, -48%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(0deg); }
        }
        .local-sad-face {
            position: absolute;
            top: 50%; 
            left: 50%;
            /* -shake 专  -translate,  爪专 住住 */
            transform: translate(-50%, -50%); 
            font-size: 5em;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            animation: fade-in-out 1.5s forwards, shake 0.1s infinite 0.5s; 
        }
        @keyframes fade-in-out {
            0% { opacity: 0; }
            30% { opacity: 1; }
            70% { opacity: 1; }
            100% { opacity: 0; }
        }

        /* 转 住 拽 转专 */
        @media (max-width: 640px) {
            .scroll {
                padding: 20px 30px;
            }
            .modal-content {
                max-width: 90%;
            }
        }
    </style>
</head>
<body>

<div class="scroll">
    <div class="title">执旨专职址旨转 址植执砖执</div>

    <!-- 祝 专 - 专 住 拽专 -->
    <div class="verse">
        <span class="emphasis">止 植执砖执</span> 值执专 驻指旨执,
        <br> 执旨 注指址职旨 指旨 址指旨执.
    </div>
    
    <div class="verse">
        <span class="emphasis">址执旨职旨 址砖指旨址执 职指指专侄抓 旨爪职指指,</span>
        <br> 旨职旨址转 址拽止旨侄砖 注址 只旨指旨.
    </div>

    <div class="verse">
        <span class="emphasis">址执旨指旨值专 址砖指旨旨注址</span> 职旨执专职址旨转 砖指止,
        <br> 职专侄址注 砖侄 砖侄拽侄, 职侄驻侄砖 砖侄 植止.
    </div>

    <div class="verse">
        <span class="emphasis">职执转职注址职旨驻旨 址植值专执</span> 值址职旨专指执,
        <br> 职指旨旨 值址职旨专旨爪止转 旨值址砖职旨指拽执.
    </div>
    
    <!-- 驻住拽 砖  -->
    <div class="highlighted-verse">
        <span class="emphasis">旨址植执砖执 值砖职旨 值爪侄 指专旨住执,</span>
        <br> 职止住 旨职砖止值址, 职执职执拽 执 拽址职指执.
    </div>

    <div class="verse">
        <span class="emphasis">职执转职址旨值旨住 址驻址旨专职指侄职</span> 职砖只职址 址植执砖执,
        <br> 址职指拽址转 址值旨专止转 转指旨止 指旨 执职专指指,
    </div>

    <div class="deluxe">
        <span class="emphasis">转职旨执 职砖执址转 址指旨 旨拽职住,</span> 职值指 砖执职指 职址址转.
    </div>

    <!-- ----- 住祝 专, 转转 注专转 砖专 注 ----- -->

    <div id="rsvp-section" class="mt-12 pt-8 border-t-2 border-dashed border-[#a0522d] w-full relative">
        <h2 class="text-2xl font-bold mb-4 text-[#6a0000]">执砖旨旨专值 址指旨注指</h2>

        <!--  驻拽 拽. 砖砖 专拽 驻专爪祝 注爪, 拽驻  注  住 -->
        <div id="local-feedback-container" class="absolute inset-x-0 bottom-4 h-24 pointer-events-none z-10"></div>
        
        <div class="flex justify-center gap-4 relative z-20">
            <!-- 驻转专 注 - 住 转" 专注 -->
            <button id="btn-attending" class="tannach-btn tannach-btn-gold">
                <span class="text-xl">址执旨注址</span>
            </button>
            <!-- 驻转专  注 - 住 驻专专 -->
            <button id="btn-not-attending" class="tannach-btn tannach-btn-ash">
                <span class="text-xl">止 址执旨注址</span>
            </button>
        </div>

        <!-- 转 专砖转 -->
        <div class="mt-10 grid grid-cols-1 md:grid-cols-2 gap-6 w-full text-right text-base" dir="rtl">
            <div class="bg-green-50 p-4 rounded-lg shadow-inner border border-green-200">
                <h3 class="text-lg font-bold text-green-700 border-b pb-2 mb-3">专职砖执址转 址址旨执旨注执 (<span id="attending-count">0</span>)</h3>
                <ul id="attending-list" class="list-none space-y-1 text-[#331a00] pr-0">
                    <!-- 专砖 转注  -->
                </ul>
            </div>

            <div class="bg-red-50 p-4 rounded-lg shadow-inner border border-red-200">
                <h3 class="text-lg font-bold text-red-700 border-b pb-2 mb-3">专职砖执址转 址侄旨注职指旨专执 (<span id="not-attending-count">0</span>)</h3>
                <ul id="not-attending-list" class="list-none space-y-1 text-[#331a00] pr-0">
                    <!-- 专砖 转注  -->
                </ul>
            </div>
        </div>
    </div>
</div>

<!--  - 注 -->
<div id="modal-attending" class="modal">
    <div class="modal-content">
        <div id="attending-form-content">
            <div class="modal-header">执砖旨旨专 址指旨注指</div>
            <form id="form-attending">
                <label for="attending-name" class="block mb-2 font-semibold">砖执职指 职旨执砖职专指值 (止 执旨旨旨):</label>
                <input type="text" id="attending-name" name="name" required class="w-full p-2 border border-gray-300 rounded mb-4 focus:outline-none focus:ring-2 focus:ring-green-500 text-right">
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('modal-attending')" class="bg-gray-400 text-white py-2 px-4 rounded hover:bg-gray-500">执旨旨旨</button>
                    <button type="submit" class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">砖职址</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!--  -  注 -->
<div id="modal-not-attending" class="modal">
    <div class="modal-content">
        <div id="not-attending-form-content">
            <div class="modal-header">止指注指 注址 侄注职值旨专旨转</div>
            <form id="form-not-attending">
                <label for="not-attending-name" class="block mb-2 font-semibold">砖执职指 职旨执砖职专指值 (止 执旨旨旨):</label>
                <input type="text" id="not-attending-name" name="name" required class="w-full p-2 border border-gray-300 rounded mb-4 focus:outline-none focus:ring-2 focus:ring-red-500 text-right">
                
                <label for="absence-reason" class="block mb-2 font-semibold">住执址旨转 址侄注职值旨专旨转:</label>
                <textarea id="absence-reason" name="reason" required class="w-full p-2 border border-gray-300 rounded mb-4 focus:outline-none focus:ring-2 focus:ring-red-500 text-right h-24"></textarea>
                
                <div class="flex justify-end gap-2">
                    <button type="button" onclick="closeModal('modal-not-attending')" class="bg-gray-400 text-white py-2 px-4 rounded hover:bg-gray-500">执旨旨旨</button>
                    <button type="submit" class="bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700">砖职址</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // --- 拽驻专爪转 API ( 专 Vercel) ---
    // 拽 拽专 砖专转 -Apps Script, 拽专 专 Vercel Serverless Function
    const API_ENDPOINT = '/api/rsvp'; // Vercel Serverless Function (抓 - 住转专 转 Apps Script URL)
    // const API_ENDPOINT = 'https://script.google.com/macros/s/AKfycbw_Pl6uINIGlwlZnF1tbzFsLb_VYrE5cpMXkWX7sDtMbq79qxw7FkdnGfcV5qqFA6WUiQ/exec'; // 砖 砖专 ( 抓) 

    let sessionId = null;

    // 专 DOM
    const btnAttending = document.getElementById('btn-attending');
    const btnNotAttending = document.getElementById('btn-not-attending');
    const attendingFormContent = document.getElementById('attending-form-content');
    const notAttendingFormContent = document.getElementById('not-attending-form-content');
    const attendingList = document.getElementById('attending-list');
    const notAttendingList = document.getElementById('not-attending-list');
    const attendingCount = document.getElementById('attending-count');
    const notAttendingCount = document.getElementById('not-attending-count');
    
    /**
     * 驻拽爪 爪专  砖驻 砖   拽 -Local Storage
     *  砖砖 转 专砖 转  驻驻/砖转砖.
     */
    function getOrCreateSessionId() {
        let id = localStorage.getItem('rsvpSessionId');
        if (!id) {
            // 爪专转   拽
            id = crypto.randomUUID(); 
            localStorage.setItem('rsvpSessionId', id);
        }
        sessionId = id;
    }


    // 驻拽爪转 爪 住转专转 
    function openModal(id) {
        document.getElementById(id).style.display = 'flex';
        if (id === 'modal-attending') restoreFormContent(id);
        if (id === 'modal-not-attending') restoreFormContent(id);
    }

    window.closeModal = function(id) {
        document.getElementById(id).style.display = 'none';
        restoreFormContent(id);
    }

    // 砖专 转 驻住 拽专 (专砖 专 爪转 注转 "转")
    function restoreFormContent(modalId) {
        //   砖专   砖驻住 转 转 砖 砖
        const isAttending = modalId === 'modal-attending';
        const formContainer = isAttending ? attendingFormContent : notAttendingFormContent;
        const formId = isAttending ? 'form-attending' : 'form-not-attending';
        const submitHandler = isAttending ? handleAttendingSubmit : handleNotAttendingSubmit;

        formContainer.innerHTML = isAttending 
            ? `
                <div class="modal-header">执砖旨旨专 址指旨注指</div>
                <form id="${formId}">
                    <label for="attending-name" class="block mb-2 font-semibold">砖执职指 职旨执砖职专指值 (止 执旨旨旨):</label>
                    <input type="text" id="attending-name" name="name" required class="w-full p-2 border border-gray-300 rounded mb-4 focus:outline-none focus:ring-2 focus:ring-green-500 text-right">
                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="closeModal('modal-attending')" class="bg-gray-400 text-white py-2 px-4 rounded hover:bg-gray-500">执旨旨旨</button>
                        <button type="submit" class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700">砖职址</button>
                    </div>
                </form>
            `
            : `
                <div class="modal-header">止指注指 注址 侄注职值旨专旨转</div>
                <form id="${formId}">
                    <label for="not-attending-name" class="block mb-2 font-semibold">砖执职指 职旨执砖职专指值 (止 执旨旨旨):</label>
                    <input type="text" id="not-attending-name" name="name" required class="w-full p-2 border border-gray-300 rounded mb-4 focus:outline-none focus:ring-2 focus:ring-red-500 text-right">
                    
                    <label for="absence-reason" class="block mb-2 font-semibold">住执址旨转 址侄注职值旨专旨转:</label>
                    <textarea id="absence-reason" name="reason" required class="w-full p-2 border border-gray-300 rounded mb-4 focus:outline-none focus:ring-2 focus:ring-red-500 text-right h-24"></textarea>
                    
                    <div class="flex justify-end gap-2">
                        <button type="button" onclick="closeModal('modal-not-attending')" class="bg-gray-400 text-white py-2 px-4 rounded hover:bg-gray-500">执旨旨旨</button>
                        <button type="submit" class="bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700">砖职址</button>
                    </div>
                </form>
            `;
        document.getElementById(formId).addEventListener('submit', submitHandler);
    }
    
    // 驻拽爪转 驻拽  (拽驻/驻专爪祝 注爪) 砖专转 驻 砖
    function showConfetti() { 
        const colors = ['#FFD700', '#A0522D', '#FFFFFF', '#6A0000']; 
        const confettiContainer = document.createElement('div');
        confettiContainer.style.position = 'fixed';
        confettiContainer.style.top = '0';
        confettiContainer.style.left = '0';
        confettiContainer.style.width = '100vw';
        confettiContainer.style.height = '100vh';
        confettiContainer.style.pointerEvents = 'none';
        confettiContainer.style.zIndex = '9999'; 
        document.body.appendChild(confettiContainer);
        const numParticles = 150; 
        for (let i = 0; i < numParticles; i++) {
            const confetti = document.createElement('div');
            confetti.className = 'confetti-particle'; 
            confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
            const centerX = window.innerWidth / 2;
            const startY = window.innerHeight / 2;
            confetti.style.left = `${centerX}px`;
            confetti.style.top = `${startY}px`;
            const angle = Math.random() * 360; 
            const velocity = Math.random() * 80 + 100; 
            const distance = Math.random() * 300 + 150; 
            const blastX = Math.cos(angle * Math.PI / 180) * velocity;
            const fallX = Math.cos(angle * Math.PI / 180) * distance;
            confetti.style.setProperty('--start-x', `${blastX}px`);
            confetti.style.setProperty('--blast-y', `${-Math.abs(blastX) - 100}px`); 
            confetti.style.setProperty('--end-x', `${fallX}px`);
            confetti.style.setProperty('--fall-y', `${window.innerHeight - startY + 50}px`); 
            confetti.style.setProperty('--rot-start', `${Math.random() * 360}deg`);
            confetti.style.setProperty('--rot-end', `${Math.random() * 1080 + 720}deg`);
            confetti.style.animationDuration = `${1.5 + Math.random() * 1.5}s`;
            confetti.style.animationDelay = `${Math.random() * 0.5}s`;
            confettiContainer.appendChild(confetti);
        }
        setTimeout(() => confettiContainer.remove(), 4000); 
    }

    function showSadFace() {
        const sadFaceContainer = document.createElement('div');
        sadFaceContainer.style.position = 'fixed';
        sadFaceContainer.style.top = '0';
        sadFaceContainer.style.left = '0';
        sadFaceContainer.style.width = '100vw';
        sadFaceContainer.style.height = '100vh';
        sadFaceContainer.style.pointerEvents = 'none';
        sadFaceContainer.style.zIndex = '9999'; 
        document.body.appendChild(sadFaceContainer);
        const sadFace = document.createElement('div');
        sadFace.className = 'local-sad-face';
        sadFace.textContent = '';
        sadFace.style.position = 'absolute';
        sadFace.style.top = '50%'; 
        sadFace.style.left = '50%';
        sadFace.style.transform = 'translate(-50%, -50%)';
        sadFaceContainer.appendChild(sadFace);
        setTimeout(() => sadFaceContainer.remove(), 2000); 
    }

    /**
     * 驻拽爪 砖转 转 -Google Apps Script (GET) 注  住转 专.
     */
    async function submitRsvp(name, status, reason = '', formContentEl) { 
        if (!sessionId) {
            console.error("Session ID is missing.");
            return;
        }

        // UI Feedback: Show loading state
        formContentEl.innerHTML = `<div class="text-center p-8">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-gray-900 mx-auto mb-4"></div>
            <p class="text-xl text-gray-700">砖 砖专...</p>
        </div>`;

        let success = false;
        let maxRetries = 3;
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                const response = await fetch(`${API_ENDPOINT}?action=submit&sessionId=${sessionId}&name=${encodeURIComponent(name)}&status=${status}&reason=${encodeURIComponent(reason)}`, { 
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    cache: 'no-store' 
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.ok) {
                        success = true;
                        break; // 爪
                    }
                }
            } catch (error) {
                console.log(`Attempt ${attempt} failed:`, error);
            }

            // 砖 (Backoff)
            if (attempt < maxRetries) {
                const delay = Math.pow(2, attempt) * 1000 + (Math.random() * 1000); 
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }

        // 注 UI 专 砖 ( 砖)
        if (success) {
            if (status === 'attending') {
                formContentEl.innerHTML = `<div class="text-center p-8">
                    <h3 class="text-3xl font-bold text-[#6a0000] mb-4">址职指 ${name}!</h3>
                    <p class="text-xl text-gray-700">专砖转 砖专 爪.</p>
                </div>`;
            } else {
                formContentEl.innerHTML = `<div class="text-center p-8">
                    <h3 class="text-3xl font-bold text-red-600 mb-4">  ${name},</h3>
                    <p class="text-xl text-gray-700">专砖  住专</p>
                </div>`;
            }
        } else {
            formContentEl.innerHTML = `<div class="text-center p-8">
                <h3 class="text-3xl font-bold text-red-600 mb-4">砖!</h3>
                <p class="text-xl text-gray-700">砖专转 专砖 砖. 住 砖 专 转专.</p>
            </div>`;
        }


        // 住专转  驻拽 
        setTimeout(() => {
            const modalId = formContentEl.closest('.modal').id;
            closeModal(modalId);
            
            if (success) {
                if (status === 'attending') {
                    showConfetti(); 
                } else {
                    showSadFace();
                }
            }
            // 专注 专砖 专 砖 爪转
            if (success) fetchRsvpsFromSheet();

        }, 1200);
    }

    /**
     * 驻拽爪 砖驻转 专砖转 -RSVPs 注转 -API.
     */
    async function fetchRsvpsFromSheet() {
        try {
            const response = await fetch(`${API_ENDPOINT}?action=getRsvps`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            if (!response.ok) {
                throw new Error(`HTTP error! status: ${response.status}`);
            }
            
            const data = await response.json();
            
            if (data && data.rsvps) {
                updateRsvpLists(data.rsvps);
            } else {
                console.error("Received unexpected data format:", data);
                attendingList.innerHTML = '<li class="text-gray-500"> 转...</li>';
                notAttendingList.innerHTML = '<li class="text-gray-500"> 转...</li>';
            }
        } catch (error) {
            console.error("Error fetching RSVP list:", error);
            attendingList.innerHTML = '<li class="text-gray-500">注...</li>';
            notAttendingList.innerHTML = '<li class="text-gray-500">注...</li>';
        }
    }

    /**
     * 注 -DOM 注 专砖转 -RSVPs 砖转拽.
     */
    function updateRsvpLists(rsvps) {
        let attending = [];
        let notAttending = [];

        rsvps.forEach((data) => {
            if (data.status === 'attending') {
                attending.push(data.name);
            } else if (data.status === 'not_attending') {
                notAttending.push({ name: data.name, reason: data.reason });
            }
        });

        // 注 专砖转 注
        attendingList.innerHTML = attending.length > 0
            ? attending.map(name => `<li class="border-b border-green-100 last:border-b-0 py-1">${name}</li>`).join('')
            : '<li class="text-gray-500">注  砖专 注...</li>';
        attendingCount.textContent = attending.length;

        // 注 专砖转 注专
        notAttendingList.innerHTML = notAttending.length > 0
            ? notAttending.map(item => 
                `<li class="border-b border-red-100 last:border-b-0 py-1">
                    <strong>${item.name}</strong> 
                    <span class="text-sm text-red-600">(${item.reason || ' 住'})</span>
                </li>`).join('')
            : '<li class="text-gray-500"> 注!</li>';
        notAttendingCount.textContent = notAttending.length;
    }

    // 驻拽爪转 驻转 砖转 驻住
    const handleAttendingSubmit = async (e) => {
        e.preventDefault();
        const nameInput = document.getElementById('attending-name');
        const name = nameInput.value.trim();
        if (name) {
            const formContainer = document.getElementById('attending-form-content');
            await submitRsvp(name, 'attending', '', formContainer); 
        }
    };

    const handleNotAttendingSubmit = async (e) => {
        e.preventDefault();
        const nameInput = document.getElementById('not-attending-name');
        const reasonInput = document.getElementById('absence-reason');
        const name = nameInput.value.trim();
        const reason = reasonInput.value.trim();

        if (name && reason) {
            const formContainer = document.getElementById('not-attending-form-content');
            await submitRsvp(name, 'not_attending', reason, formContainer); 
        }
    };


    // --- 转 驻拽爪 ---
    function initApp() {
        getOrCreateSessionId();
        
        // 注 转 专砖转 驻注 专砖
        fetchRsvpsFromSheet();
        
        // 驻注 专注   5 砖转 (Polling)
        setInterval(fetchRsvpsFromSheet, 5000); 
    }
    
    // ---  专注 ---
    btnAttending.addEventListener('click', () => {
        openModal('modal-attending');
        setTimeout(() => document.getElementById('attending-name')?.focus(), 100);
    });

    btnNotAttending.addEventListener('click', () => {
        openModal('modal-not-attending');
        setTimeout(() => document.getElementById('not-attending-name')?.focus(), 100);
    });

    // 专 -listeners 驻住
    // 砖  砖-event listeners 专 专拽 专 砖专 转 -restoreFormContent
    //  砖 拽专 -restoreFormContent 驻转转 ,  爪专 专 转  专拽 注专 转 专砖.
    //  砖 拽抓 , 砖转砖 -event listeners 砖专:
    document.getElementById('form-attending').addEventListener('submit', handleAttendingSubmit);
    document.getElementById('form-not-attending').addEventListener('submit', handleNotAttendingSubmit);

    // 驻注转 转
    initApp();

</script>
</body>
</html>
